<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·ç§¯å˜ GEMM çš„å˜å½¢è®°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Noto+Sans+SC:wght@400;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252b3b;
            --accent-cyan: #39c5bb;
            --accent-orange: #ff9f43;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px 20px;
            background-image: 
                radial-gradient(ellipse at 20% 20%, rgba(57, 197, 187, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(168, 85, 247, 0.08) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.1rem;
        }
        
        .section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .step-number {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .tensor-container {
            display: flex;
            flex-wrap: wrap;
            gap: 40px;
            justify-content: center;
            align-items: flex-start;
        }
        
        .tensor-box {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
        }
        
        .tensor-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            text-align: center;
        }
        
        .tensor-grid {
            display: grid;
            gap: 4px;
            justify-content: center;
        }
        
        .tensor-cell {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .tensor-cell:hover {
            transform: scale(1.15);
            z-index: 10;
        }
        
        .tensor-cell.highlight {
            animation: pulse 0.5s ease;
            box-shadow: 0 0 20px currentColor;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Channel colors */
        .channel-0 { background: rgba(239, 68, 68, 0.3); border: 2px solid #ef4444; color: #fca5a5; }
        .channel-1 { background: rgba(34, 197, 94, 0.3); border: 2px solid #22c55e; color: #86efac; }
        .channel-2 { background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; color: #93c5fd; }
        
        /* Kernel colors */
        .kernel-cell { background: rgba(168, 85, 247, 0.4); border: 2px solid #a855f7; color: #d8b4fe; }
        
        /* Output colors */
        .output-cell { background: rgba(255, 159, 67, 0.4); border: 2px solid #ff9f43; color: #fed7aa; }
        
        /* Matrix colors */
        .matrix-cell { background: rgba(57, 197, 187, 0.3); border: 2px solid #39c5bb; color: #a7f3d0; }
        
        .arrow {
            font-size: 3rem;
            color: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }
        
        .formula-box {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px 30px;
            margin: 20px 0;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            border-left: 4px solid var(--accent-purple);
        }
        
        .formula {
            font-size: 1.2rem;
            color: var(--accent-cyan);
        }
        
        .explanation {
            color: var(--text-secondary);
            line-height: 1.8;
            margin: 15px 0;
        }
        
        .dimension-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .dim-item {
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .dim-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .dim-value {
            color: var(--accent-orange);
            font-weight: 600;
        }
        
        .index-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .interactive-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .control-btn {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(57, 197, 187, 0.3);
        }
        
        .control-btn.active {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
        }
        
        .im2col-animation {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            justify-items: center;
        }
        
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .mapping-table th, .mapping-table td {
            padding: 12px 16px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .mapping-table th {
            background: var(--bg-tertiary);
            color: var(--accent-cyan);
        }
        
        .mapping-table tr:nth-child(even) {
            background: rgba(57, 197, 187, 0.05);
        }
        
        .highlight-row {
            background: rgba(168, 85, 247, 0.2) !important;
        }
        
        /* ä¼˜åŒ–ä»£ç å—æ ·å¼ - ä¿®å¤æ˜¾ç¤ºé—®é¢˜ */
        .code-block {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 24px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            line-height: 1.8; /* å¢åŠ è¡Œé«˜ï¼Œé¿å…æ–‡å­—é‡å  */
            white-space: pre; /* ä¿ç•™ç©ºæ ¼å’Œæ¢è¡Œï¼Œç¡®ä¿ä»£ç æ ¼å¼æ­£ç¡® */
        }
        
        .code-comment { color: #6a9955 !important; }
        .code-keyword { color: #569cd6 !important; }
        .code-string { color: #ce9178 !important; }
        .code-number { color: #b5cea8 !important; }
        .code-function { color: #dcdcaa !important; }
        
        .nhwc-nchw-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 900px) {
            .nhwc-nchw-compare {
                grid-template-columns: 1fr;
            }
            .im2col-animation {
                grid-template-columns: 1fr;
            }
            .code-block {
                font-size: 0.85rem; /* ç§»åŠ¨ç«¯é€‚é…ä»£ç å­—ä½“å¤§å° */
                padding: 18px;
            }
        }
        
        .memory-layout {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 15px 0;
        }
        
        .memory-cell {
            width: 50px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            border-radius: 4px;
        }
        
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid var(--border-color);
            z-index: 100;
        }
        
        .tensor-cell:hover .tooltip {
            opacity: 1;
        }
        
        .gemm-equation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        .gemm-matrix {
            text-align: center;
        }
        
        .gemm-matrix-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .gemm-op {
            font-size: 2rem;
            color: var(--accent-purple);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å·ç§¯å˜ GEMM çš„å˜å½¢è®°</h1>
        <p class="subtitle">ç†è§£ im2colï¼šå¦‚ä½•å°†å·ç§¯æ“ä½œè½¬æ¢ä¸ºé«˜æ•ˆçš„çŸ©é˜µä¹˜æ³•</p>
        
        <!-- å¼•è¨€ -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">0</span>
                ä¸ºä»€ä¹ˆè¦å°†å·ç§¯å˜æˆ GEMMï¼Ÿ
            </div>
            <p class="explanation">
                å·ç§¯æ“ä½œæœ¬èº«éœ€è¦å¤§é‡çš„å¾ªç¯å’Œå†…å­˜éšæœºè®¿é—®ï¼Œæ•ˆç‡è¾ƒä½ã€‚è€ŒçŸ©é˜µä¹˜æ³• (GEMM - General Matrix Multiplication) 
                å·²ç»è¢«é«˜åº¦ä¼˜åŒ–ï¼ˆBLAS åº“ã€GPU Tensor Coreï¼‰ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨ç¡¬ä»¶çš„å¹¶è¡Œèƒ½åŠ›ã€‚
                <strong>im2col</strong> ç®—æ³•å°†å·ç§¯æ ¸çš„æ»‘åŠ¨çª—å£æ“ä½œè½¬æ¢ä¸ºçŸ©é˜µä¹˜æ³•ï¼Œæ˜¾è‘—æå‡è®¡ç®—é€Ÿåº¦ã€‚
            </p>
            <div class="formula-box">
                <div class="formula">å·ç§¯ â‰ˆ im2col + GEMM + col2im</div>
            </div>
        </div>
        
        <!-- NCHW vs NHWC -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">1</span>
                NCHW vs NHWC å†…å­˜å¸ƒå±€å¯¹æ¯”
            </div>
            
            <div class="dimension-info">
                <div class="dim-item">
                    <span class="dim-label">N (Batch) = </span>
                    <span class="dim-value">1</span>
                </div>
                <div class="dim-item">
                    <span class="dim-label">C (Channel) = </span>
                    <span class="dim-value">3</span>
                </div>
                <div class="dim-item">
                    <span class="dim-label">H (Height) = </span>
                    <span class="dim-value">4</span>
                </div>
                <div class="dim-item">
                    <span class="dim-label">W (Width) = </span>
                    <span class="dim-value">4</span>
                </div>
            </div>
            
            <div class="index-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Channel 0 (R)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span>Channel 1 (G)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span>Channel 2 (B)</span>
                </div>
            </div>
            
            <div class="nhwc-nchw-compare">
                <!-- NCHW -->
                <div class="tensor-box">
                    <div class="tensor-label">NCHW (PyTorch æ ¼å¼)</div>
                    <p class="explanation" style="font-size: 0.85rem; margin-bottom: 15px;">
                        å…ˆå­˜å®Œä¸€ä¸ªé€šé“ï¼Œå†å­˜ä¸‹ä¸€ä¸ªé€šé“<br>
                        ç´¢å¼•å…¬å¼: <code>nÃ—CÃ—HÃ—W + cÃ—HÃ—W + hÃ—W + w</code>
                    </p>
                    <div id="nchw-visual"></div>
                    <p class="tensor-label" style="margin-top: 15px;">å†…å­˜çº¿æ€§å¸ƒå±€:</p>
                    <div id="nchw-memory" class="memory-layout"></div>
                </div>
                
                <!-- NHWC -->
                <div class="tensor-box">
                    <div class="tensor-label">NHWC (TensorFlow æ ¼å¼)</div>
                    <p class="explanation" style="font-size: 0.85rem; margin-bottom: 15px;">
                        å…ˆå­˜å®Œä¸€ä¸ªåƒç´ çš„æ‰€æœ‰é€šé“ï¼Œå†å­˜ä¸‹ä¸€ä¸ªåƒç´ <br>
                        ç´¢å¼•å…¬å¼: <code>nÃ—HÃ—WÃ—C + hÃ—WÃ—C + wÃ—C + c</code>
                    </p>
                    <div id="nhwc-visual"></div>
                    <p class="tensor-label" style="margin-top: 15px;">å†…å­˜çº¿æ€§å¸ƒå±€:</p>
                    <div id="nhwc-memory" class="memory-layout"></div>
                </div>
            </div>
        </div>
        
        <!-- im2col è¿‡ç¨‹ -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">2</span>
                im2col: å›¾åƒå±•å¹³ä¸ºåˆ—
            </div>
            
            <p class="explanation">
                å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª <strong>1Ã—3Ã—4Ã—4</strong> çš„è¾“å…¥ï¼ˆ1ä¸ªæ ·æœ¬ï¼Œ3ä¸ªé€šé“ï¼Œ4Ã—4å¤§å°ï¼‰ï¼Œ
                ä½¿ç”¨ <strong>3Ã—3</strong> çš„å·ç§¯æ ¸ï¼Œstride=1, padding=0ã€‚
                è¾“å‡ºå°ºå¯¸ä¸º <strong>2Ã—2</strong>ã€‚
            </p>
            
            <div class="dimension-info">
                <div class="dim-item">
                    <span class="dim-label">è¾“å…¥: </span>
                    <span class="dim-value">1Ã—3Ã—4Ã—4</span>
                </div>
                <div class="dim-item">
                    <span class="dim-label">å·ç§¯æ ¸: </span>
                    <span class="dim-value">3Ã—3 (æ¯ä¸ªè¾“å‡ºé€šé“)</span>
                </div>
                <div class="dim-item">
                    <span class="dim-label">è¾“å‡º: </span>
                    <span class="dim-value">2Ã—2</span>
                </div>
            </div>
            
            <div class="interactive-controls">
                <button class="control-btn" onclick="showWindow(0)">çª—å£ 1 (0,0)</button>
                <button class="control-btn" onclick="showWindow(1)">çª—å£ 2 (0,1)</button>
                <button class="control-btn" onclick="showWindow(2)">çª—å£ 3 (1,0)</button>
                <button class="control-btn" onclick="showWindow(3)">çª—å£ 4 (1,1)</button>
                <button class="control-btn active" onclick="animateAll()">ğŸ¬ åŠ¨ç”»æ¼”ç¤º</button>
            </div>
            
            <div class="im2col-animation">
                <!-- è¾“å…¥å¼ é‡ -->
                <div class="tensor-box">
                    <div class="tensor-label">è¾“å…¥ (3 ä¸ªé€šé“)</div>
                    <div id="input-tensor"></div>
                </div>
                
                <div class="arrow">â†’</div>
                
                <!-- im2col çŸ©é˜µ -->
                <div class="tensor-box">
                    <div class="tensor-label">im2col çŸ©é˜µ</div>
                    <div class="tensor-label" style="font-size: 0.75rem; color: var(--text-secondary);">
                        (CÃ—KÃ—K) Ã— (H_outÃ—W_out) = 27 Ã— 4
                    </div>
                    <div id="im2col-matrix"></div>
                </div>
                
                <div class="arrow">Ã—</div>
                
                <!-- å·ç§¯æ ¸çŸ©é˜µ -->
                <div class="tensor-box">
                    <div class="tensor-label">å·ç§¯æ ¸å±•å¹³</div>
                    <div class="tensor-label" style="font-size: 0.75rem; color: var(--text-secondary);">
                        å·²è½¬ç½®: 1 Ã— (CÃ—KÃ—K) = 1 Ã— 27
                    </div>
                    <div id="kernel-matrix"></div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ˜ å°„è¡¨ -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">3</span>
                å…ƒç´ ä½ç½®æ˜ å°„è¯¦è§£
            </div>
            
            <p class="explanation">
                ä¸‹è¡¨å±•ç¤ºäº†ç¬¬ä¸€ä¸ªæ»‘åŠ¨çª—å£ (ä½ç½® 0,0) ä¸­ï¼Œè¾“å…¥å¼ é‡çš„å…ƒç´ å¦‚ä½•æ˜ å°„åˆ° im2col çŸ©é˜µçš„å¯¹åº”ä½ç½®ã€‚
            </p>
            
            <table class="mapping-table">
                <thead>
                    <tr>
                        <th>åŸå§‹ä½ç½® (c, h, w)</th>
                        <th>åŸå§‹å€¼ (ç¤ºä¾‹)</th>
                        <th>im2col è¡Œå·</th>
                        <th>im2col åˆ—å·</th>
                        <th>è®¡ç®—å…¬å¼</th>
                    </tr>
                </thead>
                <tbody id="mapping-tbody">
                </tbody>
            </table>
        </div>
        
        <!-- GEMM è®¡ç®— -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">4</span>
                GEMM: çŸ©é˜µä¹˜æ³•å¾—åˆ°è¾“å‡º
            </div>
            
            <div class="gemm-equation">
                <div class="gemm-matrix">
                    <div class="gemm-matrix-label">å·ç§¯æ ¸çŸ©é˜µ W</div>
                    <div class="tensor-box" style="display: inline-block;">
                        <div style="font-family: 'JetBrains Mono'; font-size: 0.8rem;">
                            [kâ‚€ kâ‚ ... kâ‚‚â‚†]<br>
                            <span style="color: var(--text-secondary);">shape: (1, 27)</span>
                        </div>
                    </div>
                </div>
                
                <div class="gemm-op">Ã—</div>
                
                <div class="gemm-matrix">
                    <div class="gemm-matrix-label">im2col çŸ©é˜µ X</div>
                    <div class="tensor-box" style="display: inline-block;">
                        <div style="font-family: 'JetBrains Mono'; font-size: 0.8rem;">
                            [colâ‚€ colâ‚ colâ‚‚ colâ‚ƒ]<br>
                            <span style="color: var(--text-secondary);">shape: (27, 4)</span>
                        </div>
                    </div>
                </div>
                
                <div class="gemm-op">=</div>
                
                <div class="gemm-matrix">
                    <div class="gemm-matrix-label">è¾“å‡ºçŸ©é˜µ Y</div>
                    <div class="tensor-box" style="display: inline-block;">
                        <div style="font-family: 'JetBrains Mono'; font-size: 0.8rem;">
                            [yâ‚€ yâ‚ yâ‚‚ yâ‚ƒ]<br>
                            <span style="color: var(--text-secondary);">shape: (1, 4)</span><br>
                            <span style="color: var(--accent-orange);">â†’ reshape ä¸º (1, 1, 2, 2)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="formula-box">
                <div class="formula">
                    Y[out_c, out_h, out_w] = Î£(W[out_c, :] Â· X[:, out_hÃ—W_out + out_w])
                </div>
            </div>
            
            <p class="explanation">
                æ¯ä¸ªè¾“å‡ºä½ç½®çš„å€¼ = å·ç§¯æ ¸æƒé‡å‘é‡ Â· im2col å¯¹åº”åˆ—çš„ç‚¹ç§¯ã€‚<br>
                å¦‚æœæœ‰å¤šä¸ªè¾“å‡ºé€šé“ (out_channels)ï¼Œå·ç§¯æ ¸çŸ©é˜µå˜ä¸º (out_channels, 27)ï¼Œè¾“å‡ºå˜ä¸º (out_channels, 4)ã€‚
            </p>
        </div>
        
        <!-- ä»£ç ç¤ºä¾‹ - ä¿®å¤æ ¼å¼æ˜¾ç¤ºé—®é¢˜ -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">5</span>
                PyTorch ä»£ç å®ç°
            </div>
            
            <div class="code-block">
<span class="code-keyword">import</span> torch
<span class="code-keyword">import</span> torch.nn.functional <span class="code-keyword">as</span> F

<span class="code-comment"># è¾“å…¥: NCHW æ ¼å¼ (batch, channel, height, width)</span>
x = torch.randn(1, 3, 4, 4)  

<span class="code-comment"># ä½¿ç”¨ unfold å®ç° im2col (æ»‘åŠ¨çª—å£å±•å¼€)</span>
<span class="code-comment"># unfold(dimension, kernel_size, stride)</span>
x_unfold = x.unfold(2, 3, 1).unfold(3, 3, 1)
<span class="code-comment"># å±•å¼€åå½¢çŠ¶: (1, 3, 2, 2, 3, 3) = (N, C, H_out, W_out, K_h, K_w)</span>

<span class="code-comment"># é‡æ’ç»´åº¦å¹¶å±•å¹³ä¸º im2col æ ¼å¼</span>
x_col = x_unfold.permute(0, 1, 4, 5, 2, 3).reshape(1, -1, 4)
<span class="code-comment"># im2col å½¢çŠ¶: (1, 27, 4) = (N, C*K*K, H_out*W_out)</span>

<span class="code-comment"># å·ç§¯æ ¸åˆå§‹åŒ–å¹¶å±•å¹³</span>
weight = torch.randn(1, 3, 3, 3)  <span class="code-comment"># (out_channel, in_channel, K_h, K_w)</span>
w_col = weight.view(1, -1)        <span class="code-comment"># å±•å¹³ä¸º: (1, 27)</span>

<span class="code-comment"># GEMM çŸ©é˜µä¹˜æ³• (æ ¸å¿ƒæ­¥éª¤)</span>
out_col = w_col @ x_col           <span class="code-comment"># çŸ©é˜µä¹˜æ³•: (1,1,4) = (1,27) Ã— (1,27,4)</span>
out = out_col.view(1, 1, 2, 2)    <span class="code-comment"># é‡å¡‘ä¸º NCHW æ ¼å¼è¾“å‡º</span>

<span class="code-comment"># å¯¹æ¯” PyTorch å†…ç½®å·ç§¯éªŒè¯æ­£ç¡®æ€§</span>
out_conv = F.conv2d(x, weight)
diff = (out - out_conv).abs().max()
print("å·ç§¯ç»“æœä¸GEMMç»“æœæœ€å¤§å·®å¼‚:", diff)  <span class="code-comment"># å·®å¼‚æ¥è¿‘0ï¼ŒéªŒè¯æˆåŠŸ</span>
            </div>
            
            <p class="explanation" style="margin-top: 20px;">
                ä»£ç è¯´æ˜ï¼š<br>
                1.  ä½¿ç”¨ `unfold` å®ç°æ»‘åŠ¨çª—å£å±•å¼€ï¼Œæ›¿ä»£æ‰‹åŠ¨å¾ªç¯ï¼Œæ•ˆç‡æ›´é«˜<br>
                2.  `permute` è°ƒæ•´ç»´åº¦é¡ºåºï¼Œå°†å·ç§¯æ ¸ç»´åº¦èšåˆåå±•å¹³<br>
                3.  çŸ©é˜µä¹˜æ³• `@` å¯¹åº” GEMM æ“ä½œï¼Œæ˜¯è®¡ç®—æ ¸å¿ƒ<br>
                4.  æœ€ç»ˆé€šè¿‡ `view` é‡å¡‘ä¸ºå·ç§¯è¾“å‡ºæ ¼å¼ï¼Œä¸å†…ç½®å·ç§¯ç»“æœä¸€è‡´
            </p>
        </div>
        
        <!-- æ€»ç»“ -->
        <div class="section">
            <div class="section-title">
                <span class="step-number">âœ“</span>
                æ€»ç»“
            </div>
            
            <div class="explanation">
                <p><strong>ğŸ”¹ NCHW vs NHWC:</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>NCHW: é€šé“ä¼˜å…ˆï¼ŒPyTorch é»˜è®¤ï¼Œé€‚åˆ cuDNN åŠ é€Ÿ</li>
                    <li>NHWC: ç©ºé—´ä¼˜å…ˆï¼ŒTensorFlow é»˜è®¤ï¼Œé€‚åˆ CPU SIMD ä¼˜åŒ–</li>
                </ul>
                
                <p><strong>ğŸ”¹ im2col æ ¸å¿ƒæ€æƒ³:</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>å°†æ¯ä¸ªæ»‘åŠ¨çª—å£å±•å¹³æˆ im2col çŸ©é˜µçš„ä¸€åˆ—</li>
                    <li>æ‰€æœ‰é€šé“çš„çª—å£å€¼æŒ‰è¡Œæ’åˆ—ï¼ŒçŸ©é˜µå¤§å°: (C Ã— K Ã— K) Ã— (H_out Ã— W_out)</li>
                    <li>å·ç§¯æ ¸å±•å¹³ä¸ºè¡Œå‘é‡ï¼Œå¤§å°: (out_channels Ã— C Ã— K Ã— K)</li>
                </ul>
                
                <p><strong>ğŸ”¹ ä»£ä»·ä¸æ”¶ç›Š:</strong></p>
                <ul style="margin: 10px 0 20px 20px;">
                    <li>ä»£ä»·: å†…å­˜å ç”¨å¢åŠ  ~KÂ² å€ï¼ˆæ•°æ®å¤åˆ¶å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼‰</li>
                    <li>æ”¶ç›Š: åˆ©ç”¨é«˜åº¦ä¼˜åŒ–çš„ GEMM åº“ï¼ˆBLAS/CUBLASï¼‰ï¼Œæ•´ä½“è®¡ç®—é€Ÿåº¦å¤§å¹…æå‡</li>
                    <li>ç°ä»£æ¡†æ¶: æ··åˆä½¿ç”¨ Winogradã€FFTã€ç›´æ¥å·ç§¯ç­–ç•¥ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        const H = 4, W = 4, C = 3, K = 3;
        const H_out = H - K + 1, W_out = W - K + 1;
        
        // ç”Ÿæˆç¤ºä¾‹æ•°æ®
        function generateData() {
            const data = [];
            for (let c = 0; c < C; c++) {
                const channel = [];
                for (let h = 0; h < H; h++) {
                    const row = [];
                    for (let w = 0; w < W; w++) {
                        row.push(c * 100 + h * 10 + w);
                    }
                    channel.push(row);
                }
                data.push(channel);
            }
            return data;
        }
        
        const inputData = generateData();
        
        // æ¸²æŸ“ NCHW è§†å›¾
        function renderNCHW() {
            const container = document.getElementById('nchw-visual');
            const memoryContainer = document.getElementById('nchw-memory');
            let html = '';
            let memoryHtml = '';
            let memIdx = 0;
            
            for (let c = 0; c < C; c++) {
                html += `<div class="tensor-label" style="font-size: 0.75rem; margin-top: 10px;">Channel ${c}</div>`;
                html += `<div class="tensor-grid" style="grid-template-columns: repeat(${W}, 1fr);">`;
                for (let h = 0; h < H; h++) {
                    for (let w = 0; w < W; w++) {
                        const val = inputData[c][h][w];
                        html += `<div class="tensor-cell channel-${c}" data-c="${c}" data-h="${h}" data-w="${w}">
                            ${val}
                            <div class="tooltip">NCHW[0,${c},${h},${w}] = ${val}<br>å†…å­˜ä½ç½®: ${memIdx}</div>
                        </div>`;
                        memoryHtml += `<div class="memory-cell channel-${c}">${val}</div>`;
                        memIdx++;
                    }
                }
                html += '</div>';
            }
            container.innerHTML = html;
            memoryContainer.innerHTML = memoryHtml;
        }
        
        // æ¸²æŸ“ NHWC è§†å›¾
        function renderNHWC() {
            const container = document.getElementById('nhwc-visual');
            const memoryContainer = document.getElementById('nhwc-memory');
            let html = '';
            let memoryHtml = '';
            let memIdx = 0;
            
            html += `<div class="tensor-label" style="font-size: 0.75rem;">æ¯ä¸ªåƒç´  = [R, G, B]</div>`;
            html += `<div class="tensor-grid" style="grid-template-columns: repeat(${W}, 1fr);">`;
            
            for (let h = 0; h < H; h++) {
                for (let w = 0; w < W; w++) {
                    // æ˜¾ç¤ºåƒç´ ä½ç½®
                    const r = inputData[0][h][w];
                    const g = inputData[1][h][w];
                    const b = inputData[2][h][w];
                    html += `<div class="tensor-cell" style="background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(34,197,94,0.3), rgba(59,130,246,0.3)); border: 2px solid #888; font-size: 0.65rem;">
                        (${h},${w})
                        <div class="tooltip">NHWC[0,${h},${w},:] = [${r},${g},${b}]</div>
                    </div>`;
                    
                    // å†…å­˜å¸ƒå±€
                    for (let c = 0; c < C; c++) {
                        const val = inputData[c][h][w];
                        memoryHtml += `<div class="memory-cell channel-${c}">${val}</div>`;
                        memIdx++;
                    }
                }
            }
            html += '</div>';
            container.innerHTML = html;
            memoryContainer.innerHTML = memoryHtml;
        }
        
        // æ¸²æŸ“è¾“å…¥å¼ é‡ (ç”¨äº im2col æ¼”ç¤º)
        function renderInputTensor() {
            const container = document.getElementById('input-tensor');
            let html = '';
            
            for (let c = 0; c < C; c++) {
                html += `<div class="tensor-label" style="font-size: 0.7rem; margin-top: 8px;">C${c}</div>`;
                html += `<div class="tensor-grid" style="grid-template-columns: repeat(${W}, 1fr);">`;
                for (let h = 0; h < H; h++) {
                    for (let w = 0; w < W; w++) {
                        const val = inputData[c][h][w];
                        html += `<div class="tensor-cell channel-${c}" id="input-${c}-${h}-${w}" style="width: 36px; height: 36px; font-size: 0.7rem;">
                            ${val}
                        </div>`;
                    }
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        // æ¸²æŸ“ im2col çŸ©é˜µ
        function renderIm2colMatrix() {
            const container = document.getElementById('im2col-matrix');
            const rows = C * K * K;  // 27
            const cols = H_out * W_out;  // 4
            
            let html = `<div class="tensor-grid" style="grid-template-columns: repeat(${cols}, 1fr);">`;
            
            for (let row = 0; row < rows; row++) {
                const c = Math.floor(row / (K * K));
                const kh = Math.floor((row % (K * K)) / K);
                const kw = row % K;
                
                for (let col = 0; col < cols; col++) {
                    const oh = Math.floor(col / W_out);
                    const ow = col % W_out;
                    const h = oh + kh;
                    const w = ow + kw;
                    const val = inputData[c][h][w];
                    
                    html += `<div class="tensor-cell channel-${c}" id="im2col-${row}-${col}" 
                        style="width: 32px; height: 20px; font-size: 0.65rem; border-radius: 3px;"
                        data-src-c="${c}" data-src-h="${h}" data-src-w="${w}">
                        ${val}
                    </div>`;
                }
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        // æ¸²æŸ“å·ç§¯æ ¸çŸ©é˜µ
        function renderKernelMatrix() {
            const container = document.getElementById('kernel-matrix');
            const size = C * K * K;
            
            let html = `<div class="tensor-grid" style="grid-template-columns: repeat(9, 1fr);">`;
            for (let i = 0; i < size; i++) {
                html += `<div class="tensor-cell kernel-cell" style="width: 28px; height: 28px; font-size: 0.6rem;">
                    k${i}
                </div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        // é«˜äº®æ˜¾ç¤ºçª—å£
        function showWindow(windowIdx) {
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.tensor-cell').forEach(el => {
                el.classList.remove('highlight');
                el.style.opacity = '0.3';
            });
            
            const oh = Math.floor(windowIdx / W_out);
            const ow = windowIdx % W_out;
            
            // é«˜äº®è¾“å…¥ä¸­çš„çª—å£
            for (let c = 0; c < C; c++) {
                for (let kh = 0; kh < K; kh++) {
                    for (let kw = 0; kw < K; kw++) {
                        const h = oh + kh;
                        const w = ow + kw;
                        const inputEl = document.getElementById(`input-${c}-${h}-${w}`);
                        if (inputEl) {
                            inputEl.style.opacity = '1';
                            inputEl.classList.add('highlight');
                        }
                    }
                }
            }
            
            // é«˜äº® im2col å¯¹åº”çš„åˆ—
            for (let row = 0; row < C * K * K; row++) {
                const el = document.getElementById(`im2col-${row}-${windowIdx}`);
                if (el) {
                    el.style.opacity = '1';
                    el.classList.add('highlight');
                }
            }
            
            // é«˜äº®å·ç§¯æ ¸
            document.querySelectorAll('.kernel-cell').forEach(el => {
                el.style.opacity = '1';
            });
        }
        
        // åŠ¨ç”»æ¼”ç¤º
        let animationId = null;
        function animateAll() {
            if (animationId) {
                clearInterval(animationId);
            }
            let idx = 0;
            animationId = setInterval(() => {
                showWindow(idx);
                idx = (idx + 1) % (H_out * W_out);
            }, 1000);
        }
        
        // ç”Ÿæˆæ˜ å°„è¡¨
        function generateMappingTable() {
            const tbody = document.getElementById('mapping-tbody');
            let html = '';
            
            // ç¬¬ä¸€ä¸ªçª—å£ (oh=0, ow=0)
            let row = 0;
            for (let c = 0; c < C; c++) {
                for (let kh = 0; kh < K; kh++) {
                    for (let kw = 0; kw < K; kw++) {
                        const h = kh;
                        const w = kw;
                        const val = inputData[c][h][w];
                        const im2colRow = c * K * K + kh * K + kw;
                        
                        html += `<tr class="${c === 0 ? 'highlight-row' : ''}">
                            <td>(${c}, ${h}, ${w})</td>
                            <td style="color: var(--accent-orange);">${val}</td>
                            <td>${im2colRow}</td>
                            <td>0</td>
                            <td style="font-size: 0.8rem;">${c}Ã—${K}Ã—${K} + ${kh}Ã—${K} + ${kw} = ${im2colRow}</td>
                        </tr>`;
                        row++;
                        if (row >= 9) break;  // åªæ˜¾ç¤ºå‰ 9 è¡Œï¼Œé¿å…è¡¨æ ¼è¿‡é•¿
                    }
                    if (row >= 9) break;
                }
                if (row >= 9) break;
            }
            html += `<tr><td colspan="5" style="color: var(--text-secondary);">... å…± 27 è¡Œ (3 é€šé“ Ã— 3 Ã— 3 å·ç§¯æ ¸) ...</td></tr>`;
            tbody.innerHTML = html;
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰è§†å›¾
        window.onload = function() {
            renderNCHW();
            renderNHWC();
            renderInputTensor();
            renderIm2colMatrix();
            renderKernelMatrix();
            generateMappingTable();
            
            // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å…ƒç´ 
            document.querySelectorAll('.tensor-cell').forEach(el => {
                el.style.opacity = '1';
            });
        }
    </script>
</body>
</html>